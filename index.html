<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>24</title>
	<link rel="stylesheet" type="text/css" href="assets/css/24.css">
</head>
<body>
	<div class="container">
		<div class="game-info">
			<div class="pull-left">
				Time Left
				<div id="timer" class="score">
					0
				</div>
				<button id="no-solution" class="no-solution" title="Click here if you think current combination is impossible to achieve 24">
					Unsolvable
				</button>
			</div>

			<div class="center">
				<div class="logo">
					24
				</div>
			</div>

			<div class="pull-right">
				Score
				<div id="score" class="score">
					0
				</div>
				<button class="share" title="Share your score among your friends!">
					Share!
				</button>
			</div>
		</div>

		<div class="game-arena" id="arena">
			<button class="round bubble" id="bubble-0" data-bubble="0">
				1
			</button>

			<button class="round bubble" id="bubble-1" data-bubble="1">
				2
			</button>

			<button class="round bubble" id="bubble-2" data-bubble="2">
				3
			</button>

			<button class="round bubble" id="bubble-3" data-bubble="3">
				4
			</button>

			<button class="operator" id="add" data-op="+">
				+
			</button>

			<button class="operator" id="subtract" data-op="-">
				-
			</button>

			<button class="operator" id="multiply" data-op="*">
				x
			</button>

			<button class="operator" id="divide" data-op="/">
				/
			</button>
		</div>

		<div class="game-menu" id="main-menu">
			<div class="text">
				Combine the numbers to get 24 using only basic operators (addition, subtraction, multiplication, and division)!<br>
				Drag the numbers onto the others to combine, and double click on the combined numbers to undo.
			</div>

			<button class="button" id="play">
				Play
			</button>
		</div>

		<div class="game-menu" id="level-menu">
			<div class="text">
				Congratulation! You solved it!
			</div>

			<button class="button" id="next-level">
				Next
			</button>
		</div>

		<div class="game-menu" id="gameover-menu">
			<div class="text">
				Ah! That was close! BTW:
				<div id="solution"></div>
			</div>

			<button class="button" id="restart">
				Retry
			</button>
		</div>
	</div>

	<script type="text/javascript" src="assets/js/24.js"></script>
	<script src="//code.jquery.com/jquery-2.1.3.min.js" type="text/javascript"></script>
	<script src="//code.jquery.com/ui/1.11.4/jquery-ui.min.js" type="text/javascript"></script>
	<script>
$(function() {
	var game = new Game();
	var operators = ['#add', '#subtract', '#multiply', '#divide'];
	var offset = [
		{left: -80, top: 50},
		{left: -27, top: 70},
		{left: +27, top: 70},
		{left: +80, top: 50}
	];
	var activeOperand = null;

	var showOperators = (function(position) {
		var above = position.top > 500;
		$.each(operators, function(i, e) {
			$(e).show()
			.offset(position)
			.css('opacity', 0)
			.animate({
				opacity: 1,
				left: '+=' + offset[i].left,
				top: above ? '-=' + (offset[i].top + $(e).height()) : '+=' + offset[i].top,
			}, 200);
		});
	});

	var hideOperators = (function() {
		$.each(operators, function(i, e) {
			$(e).hide();
		});
		activeOperand = null;
	});

	var draggableOptions = {
		cancel: "input,textarea,select,option",
		start: function(e, ui) {
			$(this).css('z-index', 1000);
		},
		stop: function(e, ui) {
			$(this).css('z-index', 0);
		}
	};

	var droppableOptions = {
		activate: function(e, ui) {
			ui.draggable.addClass('active');
		},
		deactivate: function(e, ui) {
			ui.draggable.removeClass('active');
		},
		drop: function(e, ui) {
			var rhs = $(this).data('bubble');
			var lhs = ui.draggable.data('bubble');

			if (rhs === "x" || lhs === "x") return;

			// if there's active operand separate them
			if (activeOperand !== null) {
				$('#bubble-x').trigger('dblclick');
			}

			var bubble = newBubble(lhs, rhs);

			showOperators({
				left: bubble.offset().left + bubble.width() / 2,
				top: bubble.offset().top + bubble.height() / 2
			});
			activeOperand = {
				lhs: lhs,
				rhs: rhs
			}

			$(this).hide();
			ui.draggable.hide();
		},
		hoverClass: 'active'
	};

	var newBubble = (function(lhs, rhs) {
		var dom = $("<button/>", {
			"class": "round bubble",
			"id": "bubble-x",
			"data-bubble": "x",
			"data-bubble-lhs": lhs,
			"data-bubble-rhs": rhs,
			"text": $("#bubble-" + lhs).text() + " ... " + $("#bubble-" + rhs).text()
		}).appendTo('.game-arena');
		dom.offset({
			left: $("#bubble-" + lhs).offset().left,
			top: $("#bubble-" + lhs).offset().top
		})
		dom.draggable(draggableOptions);
		dom.droppable(droppableOptions);
		dom.show();
		return dom;
	});

	var changeMenu = (function(menu) {
		// hide the others
		$('.game-arena, .game-menu').hide();

		// show it!
		$('#' + menu).show();
	});
	// change to main menu
	changeMenu("main-menu");

	$('body').on('click', '.operator', function() {
		if (!activeOperand) return;

		var lhs = activeOperand.lhs;
		var rhs = activeOperand.rhs;

		var result = game.marry({
			lhs: lhs,
			rhs: rhs,
			op: $(this).data("op")
		});

		if (result === undefined) {
			$("#bubble-x").trigger('dblclick');
			return;
		}

		var dom = $("#bubble-x");
		dom.data("bubble", result.i);
		dom.text(result.rep);
		dom.attr("id", "bubble-" + result.i);

		hideOperators();
		activeOperand = null;
	});

	$('body').on('dblclick', '.bubble', function() {
		var bubble = $(this).data("bubble");

		if (!bubble || bubble === 'x') {
			hideOperators();
		} else {
			game.divorce(bubble);
		}

		var lhs = $(this).data("bubble-lhs");
		var rhs = $(this).data("bubble-rhs");
		if (typeof lhs !== "undefined" && typeof rhs !== "undefined") {
			$("#bubble-" + lhs).show();
			$("#bubble-" + rhs).show();
			// TODO: place them accordingly
			$("#bubble-" + lhs).offset({
				left: $(this).offset().left - 60,
				top: $(this).offset().top
			});
			$("#bubble-" + rhs).offset({
				left: $(this).offset().left + 60,
				top: $(this).offset().top
			});

			// destroy this
			$(this).remove();
		}
	});

	// draggable + droppable
	$('.bubble').draggable(draggableOptions);
	$('.bubble').droppable(droppableOptions);

	// reset bubbles!
	var reset = (function () {
		var bubbleOffset = [
			{left: 120, top: 40},
			{left: 280, top: 40},
			{left: 120, top: 220},
			{left: 280, top: 220}
		];

		// hide other bubbles
		for (var i = 4; i < 100; ++i) {
			var dom = $("#bubble-" + i);
			if (dom) dom.remove();
		}
		var dom = $("#bubble-x");
		if (dom) dom.remove();
		hideOperators();

		// setup the 4 main bubbles and arena
		changeMenu('arena');
		var numbers;
		if (game.win()) {
			numbers = game.nextLevel();
		} else {
			numbers = game.restart();
		}
		var offset = $('.game-arena').offset();
		for (var i = 0; i < 4; ++i) {
			var bubble = $("#bubble-" + i);
			bubble.show();
			bubble.offset({
				left: offset.left + bubbleOffset[i].left,
				top: offset.top + bubbleOffset[i].top
			});
			bubble.text(numbers[i]);
		}

		// set timer
		var timer = setInterval(function() {
			var timeLeft = game.getTimeLeft();
			$('#timer').text((timeLeft < 10 ? "0" : "") + timeLeft);
			$('#score').text(game.getScore());
			if (game.over()) {
				// alert("answer = " + game.getAnswer());
				// reset();
				clearInterval(timer);
				if (game.win()) {
					changeMenu('level-menu');
				} else {
					var answer = game.getAnswer();
					$('#solution').text(answer ? "24 = " + answer : "24 cannot be obtained");
					changeMenu('gameover-menu');
				}
			}
		}, 100);
	});

	$('#no-solution').click(function() {
		game.guessUnsolved();
	});

	$('#play, #next-level, #restart').on('click', function() {
		reset();
	});
});
	</script>
	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63682221-1', 'auto');
  ga('send', 'pageview');
  	</script>
</body>
</html>